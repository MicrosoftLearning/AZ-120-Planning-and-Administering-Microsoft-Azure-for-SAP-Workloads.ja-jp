---
lab:
  title: 06c - Azure Center for SAP solutions のデプロイの概要
  module: Design and implement an infrastructure to support SAP workloads on Azure
---

# AZ 1006 モジュール: Azure で SAP ワークロードをサポートするためのインフラストラクチャを設計して実装する
# AZ-1006 1 日コース ラボ 6c:Azure Center for SAP solutions を使用したデプロイの概要

予測される所要時間:60 分

AZ-1006 1 日コース ラボのすべてのタスクは Azure portal から実行します

## 目標

このラボを完了すると、次のことができるようになります。

- Azure Center for SAP solutions を使用して、Azure で SAP ワークロードをホストするインフラストラクチャをデプロイする

>**重要**: この演習で実装する前提条件は、Azure Center for SAP solutions を使って Azure に SAP ワークロードをデプロイするためのベスト プラクティスを表すことが目的では "ありません"。** その目的は、Azure Center for SAP solutions を使い、デプロイ後の管理およびメンテナンス タスクを実行することで、Azure に SAP ワークロードをデプロイするしくみを評価するために必要な時間、コスト、リソースを最小限に抑えることです。 前提条件の実装には、次のアクティビティが含まれます。

- Azure Storage アクセスのために Azure Center for SAP solutions によってデプロイ時に使用される Microsoft Entra ユーザー割り当てマネージド ID を作成する。
- Azure サブスクリプションへのデプロイ アクセスの実行に使用される Microsoft Entra ユーザー割り当てマネージド ID を付与する
- デプロイに含まれるすべての Azure 仮想マシンをホストする Azure 仮想ネットワークを作成する。

これらのアクティビティは、この演習の以下のタスクに対応します。

- タスク 1:Microsoft Entra ユーザー割り当てマネージド ID を作成する
- タスク 2:Microsoft Entra ID ユーザー割り当てマネージド ID の Azure ロールベースのアクセス制御 (RBAC) ロールの割り当てを構成する
- タスク 3:Azure 仮想ネットワークを作成する

## 手順

### 演習 1:Azure Center for SAP solutions を使って Azure での SAP ワークロードのデプロイを評価するための最低限の前提条件を実装する

期間: 15 分

この演習では、Azure Center for SAP solutions を使って、Azure での SAP ワークロードのデプロイを評価するための最低限の前提条件を実装します。 これには次のアクティビティが含まれます。

>**重要**: この演習で実装する前提条件は、Azure Center for SAP solutions を使って Azure に SAP ワークロードをデプロイするためのベスト プラクティスを表すことが目的では "ありません"。** その目的は、Azure Center for SAP solutions を使い、デプロイ後の管理およびメンテナンス タスクを実行することで、Azure に SAP ワークロードをデプロイするしくみを評価するために必要な時間、コスト、リソースを最小限に抑えることです。

前提条件の実装には、次のアクティビティが含まれます。

- Azure アクセスのために Azure Center for SAP solutions によってデプロイ時に使用される Microsoft Entra ユーザー割り当てマネージド ID を作成する。
- デプロイに含まれるすべての Azure 仮想マシンをホストする Azure 仮想ネットワークを作成する。

これらのアクティビティは、この演習の以下のタスクに対応します。

- タスク 1:Microsoft Entra ユーザー割り当てマネージド ID を作成する
- タスク 2:Azure 仮想ネットワークを作成する

#### タスク 1:Microsoft Entra ユーザー割り当てマネージド ID を作成する

このタスクでは、Azure Storage アクセスのために Azure Center for SAP solutions によってデプロイ時に使用される Microsoft Entra ユーザー割り当てマネージド ID を作成します。

1. ラボ コンピューターから Web ブラウザーを起動し、`https://portal.azure.com` の Azure portal に移動して、このラボで使用する Azure サブスクリプションの所有者のロールを持つ Microsoft アカウントまたは Microsoft Entra ID アカウントを使用して認証します。
1. Azure portal が表示されている Web ブラウザー ウィンドウの **[検索]** テキスト ボックスで、**[マネージド ID]** を検索して選択します。
1. **[マネージド ID]** ページで、 **[+ 作成]** を選択します。
1. **[ユーザー割り当てマネージド ID]** ページの **[基本]** タブで、以下の設定を指定した後、 **[確認と作成]** を選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |リソース グループ|**新しい**リソース グループ **acss-infra-RG** の名前|
   |リージョン|ACSS のデプロイに使う Azure リージョンの名前|
   |名前|**acss-infra-MI**|

1. **[確認]** タブで、検証プロセスが完了するのを待って、 **[作成]** を選択します。
1. プロビジョニング プロセスが完了するのを待ち、**[リソースに移動]** を選択して次のタスクを準備してください。 プロビジョニングにかかるのは、わずか数秒です。

#### タスク 2:Azure ロールベースのアクセス制御 (RBAC) サブスクリプション共同作成者を構成する

1. Azure portal の [マネージド ID の概要] ページで、**acss-infra-MI** の最後のタスクの完了から続行します。
1. [マネージド ID] ページのメニューの **[acss-infra-MI]** で、**[Azure ロールの割り当て]** を選択してください。
1. **[Azure のロールの割り当て]** ページで、**[ロールの割り当ての追加]** を選択します。

1. **[ロールの割り当ての追加]** ウィンドウの **[ロールの割り当ての追加]** タブで、次の設定を指定し、**保存**してください。

   |設定|値|
   |---|---|
   |Scope|**サブスクリプション**|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |ロール|**Contributor**|

#### タスク 3:デプロイの実行に使用される Microsoft Entra ID ユーザー アカウントに対する Azure ロールベースのアクセス制御 (RBAC) ロール割り当てを構成する

##### ID の追加:"Azure Center for SAP solutions サービス ロール"

1. Azure portal の **[検索]** テキスト ボックスで、 **[サブスクリプション]** を検索して選択します。
1. **[サブスクリプション]** ページで、このラボで使用する Azure サブスクリプションを表すエントリを選択します。 
1. Azure サブスクリプションのプロパティが表示されているページで、 **[アクセスの制御 (IAM)]** を選択します。
1. **[アクセスの制御 (IAM)]** ページで、 **[+ 追加]** を選択した後、ドロップダウン メニューで **[ロール割り当ての追加]** を選択します。
1. **[ロールの割り当てを追加]** ページの **[ロール]** タブの **[ジョブ関数ロール]** の一覧で、**[Azure Center for SAP solutions service role] (Azure Center for SAP solutions のサービス ロール)** エントリを検索して選択した後、**[次へ]** を選択します。
1. **[ロールの割り当てを追加]** ページの **[メンバー]** タブで、**[アクセスの割り当て先]** に対して **[Managed Identity] (マネージド ID)** を選択し、**[+ メンバーを選択する]** をクリックします。
1. **[マネージド ID の選択]** ペインで、以下の設定を指定した後、**[選択]** をクリックします。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |マネージド ID|**ユーザー割り当てマネージド ID**|
   |選択|**acss-infra-RG/subscriptions/...**|

1. **[メンバー]** タブに戻って、 **[確認と割り当て]** を選択します。
1. **[確認と割り当て]** タブで、 **[確認と割り当て]** を選択します。

##### ID の追加:"Azure Center for SAP solutions 管理者

1. **[アクセスの制御 (IAM)]** ページに戻り、**[+ 追加]** を選択した後、ドロップダウン メニューで **[ロールの割り当てを追加]** を選択します。
1. **[ロール割り当ての追加]** ページの **[ロール]** タブの **[ジョブ関数ロール]** の一覧で、 **[Azure Center for SAP solutions 管理者]** エントリを検索して選択した後、 **[次へ]** を選択します。
1. ** [メンバー]** タブ
   - (**[アクセスの割り当て先]** の) で、**[ユーザー、グループ、またはサービス プリンシパル]** を選択し、
   - **[+ メンバーを選択する]** をクリックします。
1. **[メンバーの選択]** ペインの **[選択]** テキスト ボックスに、このラボで使用している Azure サブスクリプションへのアクセスに使用した Microsoft Entra ID ユーザー アカウントの名前を入力し、エントリに一致する結果の一覧の中でそれを選択した後、**[選択]** をクリックします。
1. **[メンバー]** タブに戻って、 **[確認と割り当て]** を選択します。
1. **[確認と割り当て]** タブで、 **[確認と割り当て]** を選択します。

##### ID の追加:"マネージド ID オペレーター"

1. **[アクセスの制御 (IAM)]** ページに戻り、**[+ 追加]** を選択した後、ドロップダウン メニューで **[ロールの割り当てを追加]** を選択します。
1. **[ロール割り当ての追加]** ページの **[ロール]** タブの **[ジョブ関数ロール]** の一覧で、**[マネージド ID オペレーター]** エントリを検索して選択した後、**[次へ]** を選択します。
1. ** [メンバー]** タブ
   - (**[アクセスの割り当て先]** の) で、**[ユーザー、グループ、またはサービス プリンシパル]** を選択し、
   - **[+ メンバーを選択する]** をクリックします。
1. **[メンバーの選択]** ペインの **[選択]** テキスト ボックスに、このラボで使用している Azure サブスクリプションへのアクセスに使用した Microsoft Entra ID ユーザー アカウントの名前を入力し、エントリに一致する結果の一覧の中でそれを選択した後、**[選択]** をクリックします。
1. **[メンバー]** タブに戻って、 **[確認と割り当て]** を選択します。
1. **[確認と割り当て]** タブで、 **[確認と割り当て]** を選択します。




#### タスク 4:仮想ネットワークを作成する

このタスクでは、デプロイに含まれるすべての Azure 仮想マシンをホストする Azure 仮想ネットワークを作成します。 さらに、仮想ネットワーク内に次のサブネットを作成します。

- bastion
- app - SAP アプリケーションと SAP セントラル サービス インスタンス サーバーをホストすることを目的としています
- db - SAP データベース層をホストすることを目的としています

1. ラボ コンピューターの Azure portal が表示されている Web ブラウザー ウィンドウの **[検索]** テキスト ボックスで、**[仮想ネットワーク]** を検索して選択します。
1. **[仮想ネットワーク]** ページで、**[+ 作成]** を選択します。
1. **[仮想ネットワークの作成]** ページの **[基本]** タブで、以下の設定を指定し、 **[次へ]** を選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |リソース グループ|**acss-infra-RG**|
   |仮想ネットワーク名|**acss-infra-VNET**|
   |リージョン|この演習の前のタスクで使用したのと同じ Azure リージョンの名前|

1. **[セキュリティ]** タブの **[Azure Bastion]** で、**チェックボックス**を選択して **Azure Bastion を有効にします**。
1. 次の設定を指定し、**[次へ]** を選択してください。
   |設定|値|
   |---|---|
   |Azure Bastion ホスト名|**acss-infra-vnet-bastion**|
   |Azure Bastion のパブリック IP アドレス|**(新規) acss-infra-bastion**|

1. **[IP アドレス]** タブで、以下の設定を指定した後、**[追加]** を選択します。

   |設定|値|
   |---|---|
   |IP アドレス空間|**10.0.0.0/16 (65,536 個のアドレス)**|

1. サブネットの一覧でごみ箱アイコンを選択して、**既定のサブネット**を**削除**してください。

1. **+ サブネットの追加** を選択します。
1. **[サブネットの追加]** ペインで、以下の設定を指定してから、**[追加]** を選択します (他の設定は既定値のまま)。

   |設定|値|
   |---|---|
   |名前|**acss-admin**|
   |開始アドレス|**10.0.0.0**|
   |サイズ|**/24 (256 アドレス)**|

1. **+ サブネットの追加** を選択します。
1. **[サブネットの追加]** ペインで、以下の設定を指定してから、**[追加]** を選択します (他の設定は既定値のまま)。

   |設定|値|
   |---|---|
   |名前|**app**|
   |開始アドレス|**10.0.2.0**|
   |サイズ|**/24 (256 アドレス)**|

1. **+ サブネットの追加** を選択します。
1. **[サブネットの追加]** ペインで、以下の設定を指定してから、**[追加]** を選択します (他の設定は既定値のまま)。

   |設定|値|
   |---|---|
   |名前|**db**|
   |開始アドレス|**10.0.3.0**|
   |サイズ|**/24 (256 アドレス)**|

1. **[IP アドレス]** タブで、**[確認および作成]** を選択します。
1. **[確認および作成]** タブで、検証プロセスが完了するのを待ってから、**[作成]** を選択します。

   >**注**:プロビジョニング プロセスが部分的に進行するまで約 3 分待ってから、次のタスクに進んでください。 Azure Bastion ではプロビジョニング全体が 25 分かかる可能性があるため、**待機しません**。

### 演習 2:Azure Center for SAP solutions を使用して、Azure で SAP ワークロードをホストするインフラストラクチャをデプロイする

期間: 20 分

この演習では、Azure Center for SAP solutions のデプロイを実行します。 これには次のアクティビティが含まれます。

- Azure Center for SAP solutions を使用して、SAP ワークロードをホストできるインフラストラクチャを Azure サブスクリプションにデプロイします。

このアクティビティは、この演習の以下のタスクに対応します。

- タスク 1:Virtual Instance for SAP (VIS) solutions を作成する

>**注**:デプロイが成功したら、Azure Center for SAP solutions を使用した SAP ソフトウェアのインストールに進むことができます。 ただし、このラボには SAP ソフトウェアのインストールは含まれていません。

>**注**:Azure Center for SAP solutions を使用した SAP ソフトウェアのインストールの詳細については、Microsoft Learn のドキュメントを参照してください。このドキュメントでは、[SAP インストール メディアを取得](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/get-sap-installation-media)し、[SAP ソフトウェアをインストール](https://learn.microsoft.com/en-us/azure/sap/center-sap-solutions/install-software)する方法について説明しています。

#### タスク 1:Virtual Instance for SAP (VIS) solutions を作成する

1. ラボ コンピューターの Azure portal が表示されている Microsoft Edge ウィンドウの **[検索]** テキスト ボックスで、 **[Azure Center for SAP solutions]** を検索して選択します。
1. **[Azure Center for SAP solutions \| 概要]** ページで、 **[新しい SAP システムの作成]** を選択します。
1. **[Virtual Instance for SAP solutions の作成]** ページの **[基本]** タブで、以下の設定を指定し、 **[次へ : 仮想マシン]** を選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |リソース グループ|**acss-infra-RG**|
   |名前 (SID)|**VI1**|
   |リージョン|ACSS に登録された SAP デプロイまたは同じ地域の別のリージョンをホストしている Azure リージョンの名前|
   |環境の種類|**非実稼働**|
   |SAP 製品|**S/4HANA**|
   |データベース|**HANA**|
   |HANA スケーリング方法|**スケールアップ (推奨)**|
   |デプロイの種類|**Distributed**|
   |仮想ネットワーク|**acss-infra-VNET**|
   |アプリケーション サブネット|**app**|
   |データベース サブネット|**db**|
   |アプリケーション OS イメージのオプション|**Marketplace イメージを使用する**|
   |アプリケーション OS イメージ|**Red Hat Enterprise Linux 8.2 for SAP Applications - x64 Gen2 最新版**|
   |データベース OS イメージのオプション|**Marketplace イメージを使用する**|
   |データベース OS イメージ|**Red Hat Enterprise Linux 8.2 for SAP Applications - x64 Gen2 最新版**|
   |SAP トランスポート オプション|**新しい SAP トランスポート ディレクトリを作成する**|
   |トランスポート リソース グループ|**acss-infra-RG**|
   |ストレージ アカウント名|*空白*|
   |認証の種類|**SSH パブリック**|
   |ユーザー名|**contososapadmin**|
   |SSH 公開キーのソース|**新しいキーの組の生成**|
   |キーの組名|**contosovi1key**|
   |SQP FQDN|**sap.contoso.com**|
   |マネージド ID ソース|**既存のユーザー割り当てマネージド ID を使用する**|
   |マネージド ID 名|**acss-infra-MI**|

1. **[仮想マシン]** タブで、以下の設定を指定します。

   |設定|値|
   |---|---|
   |以下に基づいて推奨事項を生成する|**SAP Application Performance Standard (SAPS) - アプリケーション層とデータベース メモリ サイズの SAPS を提供するにはこのオプションを選択し、[推奨事項の生成] をクリックします**|
   |アプリケーション層の SAPS|**1000**|
   |データベースのメモリ サイズ (GiB)|**128**|

1. **[レコメンデーションの生成]** を選択します。
1. ASCS、アプリケーション、およびデータベース仮想マシンの VM のサイズと数を確認します。

   >**注**: 必要に応じて、仮想マシンの各セットの **[すべてのサイズを表示]** リンクを選択して代替サイズを選択することで、推奨サイズを調整します。 既定では、上で指定したアプリケーション層 SAPS とデータベース メモリ サイズに加え、高可用性を備える分散デプロイ タイプの最小 VM SKU に関する推奨事項は以下のようになります。
   - ASCS VM 用の 1 個の Standard_D4ds_v4 (それぞれ 4 個の vCPU と 16 GiB のメモリ)
   - アプリケーション VM 用の 1 個の Standard_D4ds_v4 VM (それぞれ 4 個の vCPU と 16 GiB のメモリ)
   - データベース VM 用の 1 個の Standard_E16ds_v5 (それぞれ 16 個の vCPU と 128 GiB のメモリ)

   >**注**: 必要に応じて、仮想マシンの特定の SKU の **[クォータの要求]** リンクを選択してクォータの引き上げ要求を送信することで、クォータの引き上げを要求できます。 通常、要求の処理には数分かかります。

   >**注**: Azure Center for SAP solutions では、デプロイ時に SAP でサポートされている VM SKU の使用が強制されます。

1. **[仮想マシン]** タブの **[データ ディスク]** セクションで、 **[構成の表示とカスタマイズ]** リンクを選択します。
1. **[データベース ディスクの構成]** ページで、変更を加えずに推奨構成を確認し、 **[閉じる]** を選択します。
1. **[仮想マシン]** タブに戻り、 **[次へ : アーキテクチャの視覚化]** を選択します。
1. **[アーキテクチャの視覚化]** タブで、推奨アーキテクチャを示す図を確認し、 **[確認と作成]** を選択します。
1. **[確認と作成]** タブで、検証プロセスが完了するまで待ち、"クォータ不足" エラーが発生しないようにデプロイ リージョン内に利用可能なクォータが十分あることを確認するチェックボックスを選択し、 **[作成]** を選択します。
1. 求められたら、 **[新しいキーの組の生成]** ウィンドウで、 **[秘密キーのダウンロードとリソースの作成]** を選択します。

   >**注**: デプロイに含まれる Azure VM への接続に必要な秘密キーは、このラボを実行しているコンピューターにダウンロードされます。

   >**注**:プロビジョニング プロセスが部分的に進行するまで約 3 分だけ待ってから、次のタスクに進んでください。 プロビジョニング全体に 25 分かかる場合がありますが、**待機しません**。

   >**注**:デプロイ後、Azure Center for SAP solutions を使用した SAP ソフトウェアのインストールに進むことができます。 このラボでは、SAP ソフトウェアをインストールせずに、Azure Center for SAP solutions の機能を確認します。

### 演習 3:Azure Center for SAP solutions を使用して Azure の SAP ワークロードの VIS を調べる

期間:25 分

この演習では、Azure Center for SAP solutions VIS 内のプロパティと関数を表示します。 また、ACSS によって作成された VM に接続し、作成されたディレクトリを調べることもできます。

#### タスク 1:ACSS VIS ページを確認する

1. VIS デプロイが完了したら、**[VI1 Virtual Instance for SAP solutions]** ページを表示し、次のような [Virtual Instance for SAP solutions] ページのメニューから使用可能な情報を調べます。

    1. **概要**
        - **[作業の開始]** タブには、"SAP ソフトウェアのインストール" と "既にインストールされている SAP ソフトウェアの確認" のオプションが表示されます。
        - **[プロパティ]** タブには、デプロイされた仮想マシンが表示されます。
        - **[監視]** タブには、"アプリと Central Server VM の CPU 使用率"、"データベース ディスク IOPS の使用量"、"データベース VM の CPU 使用率" が表示されます。
    1. [品質分析情報] ページの **[監視]** > **[品質分析情報]**:
        - **仮想マシン**: コンピューティング リスト、コンピューティング拡張機能、コンピューティングと OS ディスクを調べます。
        - **構成チェック**: サブ項目の選択肢を調べます。高速ネットワーク、パブリック IP、バックアップ、Load Balancer。
    1. **[Cost Management]** > **[コスト分析]**
        - **[リソース]** 列の項目を展開します。

#### タスク 2:DB VM に接続し、ACSS の構成を確認する

1. Azure portal で仮想マシンを選択し、ACSS **vi1dbvm** で作成されたデータベース VM を選択します。
1. [接続] > [Azure Bastion] の順に選択し、次の設定を選択し、**[接続]** を選択します。
    - 認証の種類 **ローカル ファイルからの SSH 秘密キー**
    - ユーザー名 **contososapadmin** 
    - ローカル ファイル ***ダウンロードした秘密キー***
    
1. Bash プロンプトで、「`mount`」と入力し、次のようなマッピングの出力を見つけてください。

```output
/dev/sdb1 on /mnt type ext4 (rw,relatime,x-systemd.requires=cloud-init.service,_netdev)
/dev/mapper/vg_sap-lv_usrsap on /usr/sap type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_hana_shared-lv_hana_shared on /hana/shared type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_hana_backup-lv_hana_backup on /hana/backup type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/vg_hana_data-lv_hana_data on /hana/data type xfs (rw,relatime,attr2,inode64,sunit=512,swidth=2048,noquota)
/dev/mapper/vg_hana_log-lv_hana_log on /hana/log type xfs (rw,relatime,attr2,inode64,sunit=128,swidth=384,noquota)
```

1. プロンプトで「`more fstab`」と入力し、SAP Media (`sapmedia`) 共有のマッピングの、次に似た出力を見つけてください。

```output
10.100.1.8:/vi2nfs9fbec656c6a60a7/sapmedia on /usr/sap/install type nfs4 (rw,relatime,vers=4.1,rsize=65536,wsize=65536,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=10.100.1.6,local_
lock=none,addr=10.100.1.8)
```

1. プロンプトで「`cd /usr/sap/install`」と入力して、`sapmedia` にマップされるディレクトリに移動してください。

1. [ACSS VIS] ページに戻り、次の項目を確認してください。
1. Azure UI:プライベート リンク > プライベート エンドポイント Azure UI:ACSS インストール ソフトウェア UI の表示

### 演習 4 (任意):Azure Center for SAP solutions を使用して Azure で SAP ワークロードを維持する

期間: 20 分

この演習では、Azure Center for SAP solutions を使用して、デプロイ後の管理と SAP ワークロードの監視について確認します。 これには次のアクティビティが含まれます。

- Azure Center for SAP solutions によって管理される SAP ワークロードのバックアップの前提条件を確認する
- Azure Center for SAP solutions によって管理される SAP ワークロードのディザスター リカバリーの前提条件を確認する
- Azure Center for SAP solutions によって管理される SAP ワークロードで使用できる監視オプションを確認する
- このラボでプロビジョニングした Azure リソースをすべて削除する。

これらのアクティビティは、この演習の以下のタスクに対応します。

- タスク 1:Azure Center for SAP solutions によって管理される SAP ワークロードのバックアップの前提条件を確認する
- タスク 2:Azure Center for SAP solutions によって管理される SAP ワークロードのディザスター リカバリーの前提条件を確認する
- タスク 3:Azure Center for SAP solutions によって管理される SAP ワークロードの監視オプションを確認する
- タスク 4:ラボでプロビジョニングした Azure リソースを削除する

#### タスク 1:Azure Center for SAP solutions によって管理される SAP ワークロードのバックアップの前提条件を確認する

>**注**:Azure Center for SAP solutions の VIS リソース レベルで Azure Backup を構成すると、データベース、アプリケーション サーバー、SAP セントラル サービス インスタンスをホストする Azure VM と HANA DB のバックアップを 1 つの手順で有効にすることができます。 HANA DB バックアップについては、Azure Center for SAP solutions でバックアップの事前登録スクリプトが自動的に実行されます。

1. ラボ コンピューターの Azure portal が表示されている Microsoft Edge ウィンドウの **[検索]** テキスト ボックスで、 **[Azure Center for SAP solutions]** を検索して選択します。
1. **[Azure Center for SAP Solutions \| 概要]** ページの左側にある縦型ナビゲーション メニューで、**[Virtual Instance for SAP solutions]** を選択し、仮想インスタンスの一覧で、前の演習でデプロイしたインスタンスを選択します。
1. 仮想インスタンス ページの左側にある縦型ナビゲーション メニューの **[操作]** セクションで、**[バックアップ (プレビュー)]** を選択します。
1. この SAP システムの SAP ソフトウェアのインストールまたは登録が完了していないためにバックアップをセットアップできないことを示すメッセージに注意してください。

   >**注**:これは予測されていることです。 SAP ソフトウェアのインストールが完了するまで、この方法でバックアップを設定することはできません。 ただし、セットアップを完了するには、コンテナーとバックアップ ポリシーの作成など、追加の前提条件も必要です。それについて、ここで確認します。 

1. ラボ コンピューターの Azure portal が表示されている Microsoft Edge ウィンドウの **[検索]** テキスト ボックスで、**[バックアップ センター]** を検索して選択します。 
1. **[バックアップ センター]** ページの左側にある縦型ナビゲーション メニューの **[管理]** セクションで、**[コンテナー]** を選択します。
1. **[バックアップ センター \| コンテナー]** ページで、**[+ コンテナー]** を選択します。
1. **[開始: コンテナーの作成]** ページで、使用可能なコンテナーの種類を確認し、**Recovery Services コンテナー** (**Azure 仮想マシン**と **Azure VM の SAP HANA** のデータソースの種類をサポート) が選択されていることを確認してから、**[続行]** を選択します。
1. **[Recovery Services コンテナーの作成]** ページの **[基本]** タブで、以下の設定を指定し、**[次へ: 冗長性]** を選択します

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |リソース グループ|**新しい**リソース グループ **acss-mgmt-RG** の名前|
   |Vault 名|**acss-backup-RSV**|
   |リージョン|ACSS に登録された SAP デプロイをホストしている Azure リージョンの名前|

1. **[冗長性]** タブで、以下の設定を指定し、**[次へ: コンテナーのプロパティ]** を選択します

   |設定|Value|
   |---|---|
   |バックアップ ストレージの冗長性|**geo 冗長**|
   |リージョンをまたがる復元|**有効にする**|

1. **[コンテナーのプロパティ]** タブで、**不変性を有効にする**設定を有効にせずに確認し、**[次へ: ネットワーク]** をクリックします
1. **[ネットワーク]** タブで、既定のオプションの **[すべてのネットワークからのパブリック アクセスを許可する]** をそのまま使い、**[確認および作成]** を選びます
1. この演習は確認のみを行うため、**[作成]** を**選択しないでください**。
1. **[確認と作成]** タブで、検証プロセスが完了したら、[Azure Center for SAP solutions] ページに戻ってください (バックアップの設定は失われます)。  

   >**注**:Azure Center for SAP solutions UI の[バックアップ (プレビュー)](https://learn.microsoft.com/azure/sap/center-sap-solutions/acss-backup-integration) 機能は、*プレビュー*から*一般提供*にリリースされた後、バックアップ構成を完了するための推奨される方法になります。

   >**注**:Azure Center for SAP solutions のインターフェイスで VIS レベルのバックアップを構成する場合は、既存のコンテナーとそのポリシーを利用できます。

   >**注**:VIS レベルでバックアップを構成したら、Azure portal の VIS インターフェイスから Azure VM と HANA DB のバックアップ ジョブの状態を監視できます。

#### タスク 2:Azure Center for SAP solutions によって管理される SAP ワークロードのディザスター リカバリーの前提条件を確認する

>**注**:Azure Center for SAP solutions サービスはゾーン冗長サービスですが、リージョンが停止した場合に Microsoft によって開始されるフェールオーバーはありません。 このようなシナリオを修復するには、「[SAP ワークロードのディザスター リカバリーの概要とインフラストラクチャのガイドライン](https://learn.microsoft.com/en-us/azure/sap/workloads/disaster-recovery-overview-guide)」で説明されている Azure Site Recovery (ASR) の使用を含むガイダンスに従って、Azure Center for SAP solutions を使用してデプロイした SAP システムのディザスター リカバリーを構成する必要があります。 このタスクでは、そのガイダンスを使用した ASR ベースのディザスター リカバリー ソリューションの実装プロセスを順を追って説明します。

>**注**:ASR は、アプリケーション サーバーと SAP セントラル サービス インスタンス用に推奨されるソリューションです。 データベース サーバー用には、それらのネイティブ レプリケーション機能の使用を検討してください。

1. ラボ コンピューターの Azure portal が表示されている Microsoft Edge ウィンドウの **[検索]** テキスト ボックスで、**[Recovery Services コンテナー]** を検索して選択します。
1. **[Recovery Services コンテナー]** ページで、**[+ 作成]** を選択します。
1. **[Recovery Services コンテナーの作成]** ページの **[基本]** タブで、以下の設定を指定し (他の設定は既定値のままにして)、**[次へ: 冗長性]** を選択します。

   |設定|値|
   |---|---|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |リソース グループ|**新しい**リソース グループ **acss-dr-RG** の名前|
   |Vault 名|**acss-dr-RSV**|
   |リージョン|ACSS 登録済み SAP デプロイとペアになっている Azure リージョンの名前|

   >**注**:運用ワークロードをホストしているリージョンとペアになっているリージョンを特定するには、[Azure のペアになっているリージョン](https://learn.microsoft.com/en-us/azure/reliability/cross-region-replication-azure#azure-paired-regions)について説明している MS Learn ドキュメントを参照してください。

1. **[冗長性]** タブで、以下の設定を指定し、**[次へ: コンテナーのプロパティ]** を選択します

   |設定|Value|
   |---|---|
   |バックアップ ストレージの冗長性|**ローカル冗長**|

1. **[コンテナーのプロパティ]** タブで、**不変性を有効にする**設定を有効にせずに確認し、**[次へ: ネットワーク]** をクリックします
1. **[ネットワーク]** タブで、既定のオプションの **[すべてのネットワークからのパブリック アクセスを許可する]** をそのまま使い、**[確認および作成]** を選びます
1. **[確認と作成]** タブで、検証プロセスが完了するのを待って、 **[作成]** を選択します。

   >**注**:プロビジョニング プロセスが完了するのを待たずに、次のステップに進んでください。 プロビジョニングには 2 分ほどかかる場合があります。

   >**注**:ここで、Recovery Services コンテナーを作成したペアになっているリージョンに、ディザスター リカバリー環境を設定します。 この環境には、Azure VM (Virtual Instance for SAP をプロビジョニングしたプライマリ リージョンで現在ホストされている) のレプリカをホストする仮想ネットワークが含まれます。 

1. ラボ コンピューターの Azure portal が表示されている Microsoft Edge ウィンドウの **[検索]** テキスト ボックスで、**[Recovery Services コンテナー]** を検索して選択します。
1. **[Recovery Services コンテナー] **ページで、**[acss-dr-RSV]** を選択します。
1. **[acss-dr-RSV]** ページの左側にある縦型メニューの **[作業の開始]** セクションで、**[Site Recovery]** を選択します。
1. **[acss-dr-RSV \| Site Recovery]** ページの **[Azure 仮想マシン]** セクションで、次を選択します: **1. レプリケーションを有効にする**。 
1. **[レプリケーションの有効化]** ページの **[ソース]** タブで、以下の設定を指定し、**[次へ]** を選択します。

   |設定|Value|
   |---|---|
   |リージョン|Virtual Instance for SAP (VIS) をホストしている Azure リージョンの名前|
   |サブスクリプション|このラボで使う Azure サブスクリプションの名前|
   |リソース グループ|**acss-vi-RG**|
   |仮想マシン デプロイ モデル|**Resource Manager**|
   |可用性ゾーン間でのディザスター リカバリー|**いいえ**|

   >**注**:**可用性ゾーン間のディザスター リカバリー**は、ソース リージョンで可用性ゾーンをサポートされているかどうかによって、構成できない場合があります。

1. **[仮想マシン]** タブで、一覧から最初の 4 台の仮想マシン (**vi1appvm0**、**vi1appvm1**、**vi1ascsvm0**、**vi1ascsvm0**) を選択し、**[次へ]** を選択します。

   >**注**:前述のように、ASR ベースのレプリケーションは、アプリケーション サーバーと SAP セントラル サービス インスタンスに適用されます。 データベース サーバーは、ネイティブのデータベース レプリケーション機能を使用することで、同期された状態に維持されます。

1. **[レプリケーション設定]** タブで、以下の操作を実行します。

   1. 必要に応じて、**[ターゲットの場所]** ドロップダウン リストで、**acss-dr-RSV** Recovery Services コンテナーを作成した Azure リージョンを選択します。
   1. このラボで使われている Azure サブスクリプションの名前が **[ターゲット サブスクリプション]** ドロップダウン リストに表示されていることを確認します。
   1. **[ターゲット リソース グループ]** ドロップダウン リストで、**[acss-dr-RG]** を選択します。
   1. **[フェールオーバー仮想ネットワーク]** ドロップダウン リストで、**[新規作成]** を選びます。
   1. **[仮想ネットワークの作成]** ペインの **[名前]** テキスト ボックスに「**CONTOSO-VNET-asr**」と入力します
   1. **[アドレス空間]** セクションの **[アドレス範囲]** テキスト ボックスで、既定のエントリを「**10.10.0.0/16**」に置き換えます。
   1. **[サブネット]** セクションの **[サブネット名]** テキスト ボックスに「**app**」と入力し、**[アドレスの範囲]** テキスト ボックスに「**10.10.0.0/24**」と入力します。
   1. 新しく追加したサブネット エントリの下の **[サブネット]** セクションにある **[サブネット名]** テキスト ボックスに「**db**」と入力し、**[アドレスの範囲]** テキスト ボックスに、「**10.10.2.0/24**」と入力します。
   1. **[仮想ネットワークの作成]** ペインで **[OK]** を選びます。
   1. **[レプリケーションを有効にする]** ページに戻り、**[フェールオーバー サブネット]** ドロップダウン リストに "**(新規) app (10.10.0.0/24)**" エントリが表示されることを確認します。
   1. **[ストレージ]** セクションで、**[ストレージ構成の表示/編集]** リンクを選択します。
   1. **[ターゲットの設定のカスタマイズ]** ページで構成結果を確認しますが、変更は行わず、**[キャンセル]** を選びます。
   1. **[可用性オプション]** セクションで、**[可用性オプションの表示/編集]** リンクを選択します。
   1. **[可用性オプション]** ページでは、ターゲット リソースに近接配置グループを実装するオプションがありますが、変更は行わず、**[キャンセル]** を選びます。

   >**注**:容量予約を構成するオプションもあります。

   >**注**:また、レプリケーション ポリシー設定を構成するオプションもあります。

   >**重要**: IP アドレス空間は、プライマリおよびセカンダリ リージョンの仮想ネットワーク間で異なることに注意してください。 これは意図的なもので、これによって、2 つのリージョンでホストされているデータベース サーバー間のレプリケーションを構成するために必要な 2 つの仮想ネットワークを相互に接続できるようになります。 このような接続は、仮想ネットワーク ピアリングを使用して確立できます。

1. **[レプリケーションの有効化]** ページの **[レプリケーション設定]** タブで、**[次へ]** を選択してください。
1. **[レプリケーションの有効化]** ページの **[管理]** タブで、**[次へ]** を選択します。
1. **[レプリケーションの有効化]** ページの **[確認]** タブで、設定を確認してください。 この演習では、レプリケーションを **有効にしません**。

   >**注**:通常、初期レプリケーションの完了にはかなり時間がかかります。 このラボの割り当て時間は限られていることを考慮し、このタスクの一部として実行する追加の手順については、講師に問い合わせてください。 具体的なガイダンスがない場合は、そのまま次のタスクに進んでください。

   >**注**:この時点で Azure Bastion と Azure Firewall の両方をプロビジョニングすることもできますが、そうするのではなくディザスター リカバリー フェールオーバー手順の一部としてプロビジョニングを自動化しましょう。 これにより、ディザスター リカバリー環境の維持に関連する料金が最小限に抑えられます。 その環境で、プライマリ Virtual Instance for SAP の Azure Premium ファイル共有やカスタム ルーティングなどの構成を反映する他のコンポーネントにも、同じことが当てはまります。

#### タスク 3:Azure Center for SAP solutions によって管理される SAP ワークロードの監視オプションを確認する

>**注**:バックアップと同様に、Azure Center for SAP solutions の監視機能を完全に体験することはできません。 そのためには、SAP ソフトウェアのインストールまたは既存の Azure Monitor for SAP solutions インスタンスの登録が必要です。 代わりに、このタスクでは、Virtual Instance for SAP solutions で使用できるインターフェイスを順に見ていきながら、これらの機能を特定して確認します。

1. ラボ コンピューターの Azure portal が表示されている Microsoft Edge ウィンドウの **[検索]** テキスト ボックスで、**[Virtual Instances for SAP solutions]** を検索して選択します。 
1. **[Virtual Instances for SAP solutions]** ページで、全体的な正常性と状態のビジュアル インジケーターを含めて、**VI1** インスタンスの状態の概要情報を確認します。
1. **[Virtual Instances for SAP solutions]** ページで、**[VI1]** を選択します。
1. **[VI1]** ページの左側にある縦型ナビゲーション メニューで **[概要]** を選択し、右側のペインで **[監視]** を選択します。
1. 監視ペインに表示される監視テレメトリを確認します。

   >**注**:監視ペインには、アプリケーション サーバー、データベース サーバー、SAP セントラル サービス インスタンスの vCPU 使用率のグラフとメトリックが含まれています。 また、データベース ディスク IOPS 統計データベース サーバーも含まれます。 

1. **[VI1]** ページの左側にある縦型ナビゲーション メニューの **[監視]** セクションで、**[Quality insights]\(品質の分析情報\)** を選択します。
1. **[VI1 \| Quality insights (品質の分析情報) \| ブック 1]** ページで、**[アドバイザーの推奨事項]** タブを確認 します。これは、Virtual Instance for SAP solutions (VIS)、セントラル サーバー インスタンス、App Service インスタンス、データベースの最適化に関する推奨事項を提供することを目的としています。

   >**注**:これらの推奨事項では、SAP ソフトウェアのインストールを完了することが求められます。

1. **[VI1 \| Quality insights (品質の分析情報) \| ブック 1]** ページで、**[仮想マシン]** タブを選択し、**[Azure Compute]**、**[コンピューティングの一覧]**、**[コンピューティング拡張機能]**、**[コンピューティングと OS ディスク]**、**[コンピューティングとデータ ディスク]** の各タブの内容を確認します。

   >**注**:これらの各タブには、Virtual Instance for SAP solutions の一部である Azure VM から収集された実際のデータが含まれています。

1. **[VI1 \| Quality insights (品質の分析情報) \| ブック 1]** ページで、**[構成チェック]** タブを選択し、**[高速ネットワーク]**、**[パブリック IP]**、**[バックアップ]**、**[ロード バランサー]** の各タブの内容を確認します。 この内容は、Virtual Instance for SAP solutions のコンピューティングとネットワークのコンポーネントについて、パフォーマンスとセキュリティに関連した設定の概要を簡単に示しています。 **[ロード バランサー]** タブには、ロード バランサーの主要なメトリックを表示する **[ロード バランサーのモニター]** の情報が含まれています。
1. **[VI1]** ページの左側にある縦型ナビゲーション メニューの **[監視]** セクションで、**[Azure Monitor for SAP solutions]** を選択します。
1. **[VI1 \| Azure Monitor for SAP solutions]** ページで、VIS の SAP ソフトウェアのインストールまたは登録が完了していないために AMS をセットアップできないことを示すメッセージに注意してください。

   >**注**:SAP ソフトウェアは、インストールすると、新規または既存の Azure Monitor for SAP solutions リソースと統合できるようになります。 Azure Monitor for SAP solutions は、Log Analytics とブックの Azure Monitor 機能を使用して、カスタムの視覚化、クエリ、アラートのサポートなど、Azure VM でホストされている SAP ワークロードの包括的な監視を提供します。
